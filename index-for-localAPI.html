<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>uGym 參加會員</title>
  <!--  <link rel="stylesheet" href="css/main.css">-->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <!--  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">-->
  <script src="https://code.jquery.com/jquery-1.12.3.min.js"></script>
  <!--  <script src="js/jquery.twzipcode.min.js"></script>-->

</head>

<body>
  <div id="joinFormHeader" class="w3-container w3-blue">
    <h2 style="font-family: 'Noto Sans TC'">加入林口運動中心會員</h2>
  </div>

  <div id="joinForm" class="w3-container" style="font-family: 'Noto Sans TC'">
    <p>
      <label>姓名(必填)</label>
      <input id="name" class="w3-input" type="text"></p>
    <p>
      <label>姓別(必填，Inbody 量測使用)</label>
      <select id="gender" class="w3-select" name="option">
        <option value="" disabled selected>男，女或保密</option>
        <option value="男">男</option>
        <option value="女">女</option>
        <option value="保密">保密</option>
      </select></p>
    <p>
      <label>身高(必填，Inbody 量測使用)</label>
      <input id="bodyHeight" class="w3-input" type="text" placeholder="例如: 180cm"></p>
    <p>
      <label>生日(必填，Inbody 量測使用)</label>
      <input id="birthday" class="w3-input" type="text" placeholder="格式 2020-01-01"></p>      
    <p>     
      <label>電話</label>
      <input id="phone" class="w3-input" type="text"></p>
    <p>
      <label>身分證號(必填，作為會員身份辨識，不用做其他用途)</label>
      <input id="identity" class="w3-input" type="text"></p>
    <p>
      <label>地址</label>
      <input id="address" class="w3-input" type="text"></p>
    <p>
      <button class="w3-btn w3-block w3-indigo" onclick="addConfirm()">加入會員</button>
    </p>
    <p>
      <label>點擊 加入會員 表示您同意以下隱私權以及資料使用條款聲明</label>
    </p>
  </div>

  <div class="w3-container">
    <div id="finishMessage" style="display: none">
      <h3 style="font-family: 'Noto Sans TC'">您已成功加入會員，謝謝!</h3>
    </div>

    <div id="errorMessage" style="display: none">
      <h3 style="font-family: 'Noto Sans TC'">發生錯誤，請洽管理員。</h3>
    </div>

    <div id="alreadyMessage" style="display: none">
      <h3 style="font-family: 'Noto Sans TC'">您以前已經加入會員!</h3>
    </div>
  </div>

  <script>
    var memberData = [];
    var dataToAdd = [];
    var paramToSend;
    var inputParamString = location.search;
    var inputError = false;
    //var userIdString = location.search;        

    // 處理輸入參數
    var inputParam = inputParamString.split("&");
    // inputParam[0]="?displayName=..."
    // inputParam[1]="userId=..."
    // inputParam[2]="pictureUrl=..."
    try {
      var displayName = inputParam[0].split("=");
      var userId = inputParam[1].split("=");
      var pictureUrl = inputParam[2].split("=");
    } catch (e) {
      alert("輸入參數錯誤");
      $("#joinForm").hide();
      $("#errorMessage").css("display", "block");
      inputError = true;
    }

    if (!inputError) {
      console.log(displayName, userId, pictureUrl);

      if (userId[0] == "userId") {
        console.log("valid UserId ", userId[1]);

        checkUserIdExist();

        $("#name").val(decodeURI(displayName[1]));


      } else {
        $("#joinForm").hide();
        $("#errorMessage").css("display", "block");
        alert("No LINE ID!!");
      }
    }

    function checkUserIdExist() {
      //Call API:00 檢查 userId 有沒有重複參加 */

      paramToSend = "?API=00" + "&UserId=" + userId[1];

      var request = new XMLHttpRequest()
      //request.open('GET', 'https://api-ugym-courses.herokuapp.com/'+paramToSend, true)
      request.open('GET', 'http://localhost:5000' + paramToSend, true)

      request.onload = function() {
        console.log(this.response);
        if (this.response == "API:00 會員已存在") {
          $("#joinForm").hide();
          $("#joinFormHeader").hide();
          //$("#alreadyMessage").css("display", "block");            
          alert("您以前已經加入會員! 前往團課");
          // 顯示團課表格
          console.log("前往團課");

        }
      }
      // Send API request 
      request.send();
    }

    function addConfirm() {
      console.log("addConfirm");
      // TODO: 檢查資料格式     
      if ($("#name").val() == "") {
        alert("姓名為必填!");
        return 0;
      }

      paramToSend = "?API=01" +
        "&UserId=" + userId[1] +
        "&Name=" + $("#name").val() +
        "&Gender=" + $("#gender").val() +     
        "&Birth=" + $("#birthday").val() +
        "&Phone=" + $("#phone").val() +
        "&ID=" + $("#identity").val() +
        "&Address=" + $("#address").val() +
        "&Height=" + $("#bodyHeight").val() +
        "&PicURL=" + pictureUrl[1];

      var profile = "請確認會員資料:\n" +
        "    會員姓名: " + $("#name").val() + "\n" +
        "    會員姓別: " + $("#gender").val() + "\n" +
        "    會員身高: " + $("#bodyHeight").val() + "\n" +          
        "    會員生日: " + $("#birthday").val() + "\n" +
        "    會員電話: " + $("#phone").val() + "\n" +
        "    身分證號: " + $("#identity").val() + "\n" +
        "    會員地址: " + $("#address").val();

      console.log(paramToSend);

      //window.location("https://member-join-form-for-line.herokuapp.com/"+paramToSend);
      //webCourseAPI();      

      if (confirm(profile)) {

        // call API:01
        var request = new XMLHttpRequest()
        //request.open('GET', 'https://api-ugym-courses.herokuapp.com/'+paramToSend, true)
        request.open('GET', 'http://localhost:5000' + paramToSend, true)

        request.onload = function() {
          console.log(this.response);

          if (this.response == "API:01 會員寫入成功") {
            $("#joinForm").hide();
            $("#joinFormHeader").hide();
            //$("#finishMessage").css("display", "block"); 
            alert("會員加入成功，前往團課")
            // 顯示團課表格
            console.log("前往團課");

          } else {
            alert("會員加入失敗，請洽管理員")
            $("#joinForm").hide();
            $("#errorMessage").css("display", "block");
          }

        }
        // Send request
        request.send();

      };
    };
  </script>


</body>

</html>